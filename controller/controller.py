#!/usr/bin/env python
"""This is a simple multi-process manager for running two-cover descent on many curves.
The program maintains a queue of curves, starts processes for multiple curves at once,
and monitors the processes for excess memory usage or overly long runtimes."""

from controller_inner import set_memory_limit, run_curve

from concurrent.futures import TimeoutError
from pebble import ProcessPool, ProcessExpired

TIME_LIMIT = 1800 # seconds
MAX_MEM = 1024 * 1024 * 1024 # bytes
MAX_WORKERS = 10 # number of concurrent processes
MAX_TASKS = 1 # max tasks a process completes before restarting

TEST_LABELS = ("6443.a.6443.1", "6982.a.13964.1", "7211.a.7211.1", "7403.a.7403.1", "7445.a.7445.1",)

LABELS = (
    "6443.a.6443.1", "6982.a.13964.1", "7211.a.7211.1", "7403.a.7403.1", "7445.a.7445.1",
    "7627.a.7627.1", "7662.b.45972.1", "7877.d.7877.1", "8303.b.8303.1", "8579.a.8579.1",
    "8711.a.8711.1", "8864.a.17728.1", "9055.a.45275.1", "9259.a.9259.1", "9278.a.18556.1",
    "9446.a.18892.1", "9523.a.9523.1", "9589.b.9589.1", "9633.a.28899.1", "9783.a.29349.1",
    "9803.a.9803.1", "9959.a.9959.1", "10037.a.10037.1", "10073.a.10073.1", "10328.a.20656.1",
    "10762.a.21524.1", "10895.a.54475.1", "11027.a.11027.1", "11079.a.33237.1", "11168.a.22336.1",
    "11189.a.11189.1", "11269.a.11269.1", "11347.b.11347.1", "11383.b.11383.1", "11519.a.11519.1",
    "11749.a.11749.1", "11971.b.11971.1", "12010.a.24020.1", "12032.c.24064.1", "12050.a.24100.1",
    "12076.a.48304.1", "12092.a.48368.1", "12153.a.36459.1", "12691.a.88837.1", "12761.a.89327.1",
    "12890.a.25780.1", "12941.a.12941.1", "12949.a.12949.1", "13078.a.26156.1", "13100.a.52400.1",
    "13227.a.13227.1", "13298.a.26596.1", "13349.a.13349.1", "13418.a.26836.1", "14067.c.14067.1",
    "14087.a.14087.1", "14138.a.28276.1", "14197.a.14197.1", "14237.a.14237.1", "14481.a.43443.1",
    "14545.a.72725.1", "14558.a.29116.1", "14639.a.14639.1", "14725.a.14725.1", "14752.a.29504.1",
    "14890.a.29780.1", "14891.a.14891.1", "14899.b.14899.1", "14998.a.29996.1", "15019.a.15019.1",
    "15095.a.15095.1", "15371.a.15371.1", "15538.a.31076.1", "15681.a.47043.1", "15811.a.15811.1",
    "15867.a.47601.1", "15901.b.15901.1", "16027.a.16027.1", "16190.a.32380.1", "16217.a.16217.1",
    "16473.a.49419.1", "16877.a.16877.1", "16978.a.33956.1", "17031.a.51093.1", "17149.a.17149.1",
    "17245.a.86225.1", "17273.b.17273.1", "17279.a.17279.1", "17317.a.17317.1", "17327.a.17327.1",
    "17477.a.17477.1", "17525.a.17525.1", "17789.a.17789.1", "18289.a.18289.1", "18317.a.18317.1",
    "18507.a.55521.1", "18597.a.55791.1", "18646.a.37292.1", "18652.a.74608.1", "18835.a.18835.1",
    "18895.a.94475.1", "19119.b.57357.1", "19328.b.38656.1", "19365.a.19365.1", "19377.a.58131.1",
    "19483.a.19483.1", "19517.a.19517.1", "19616.b.39232.1", "20371.a.20371.1", "20386.a.40772.1",
    "20427.a.20427.1", "20626.a.41252.1", "20656.a.82624.1", "20716.a.82864.1", "20721.a.62163.1",
    "20823.a.62469.1", "20971.a.20971.1", "20974.a.41948.1", "21133.a.21133.1", "21653.a.21653.1",
    "21664.c.43328.1", "22141.a.22141.1", "22219.a.22219.1", "22229.a.22229.1", "22291.a.22291.1",
    "22432.a.44864.1", "22532.a.90128.1", "22711.a.22711.1", "22757.a.22757.1", "22811.a.22811.1",
    "22861.a.22861.1", "22891.a.22891.1", "22934.b.91736.1", "22952.b.45904.1", "23043.a.23043.1",
    "23339.a.23339.1", "23631.a.70893.1", "23764.a.95056.1", "23889.a.71667.1", "23941.a.23941.1",
    "24064.b.96256.1", "24106.a.48212.1", "24181.b.24181.1", "24242.a.48484.1", "24267.a.72801.1",
    "24340.a.97360.1", "24461.a.24461.1", "24471.a.73413.1", "24533.a.24533.1", "24629.b.24629.1",
    "24729.a.74187.1", "24778.a.49556.1", "24829.a.24829.1", "24903.a.74709.1", "24975.a.24975.1",
    "25029.a.25029.1", "25477.a.25477.1", "25504.a.51008.1", "25547.a.25547.1", "25927.a.25927.1",
    "25963.a.25963.1", "26053.b.26053.1", "26232.a.52464.1", "26391.a.79173.1", "26415.a.79245.1",
    "26439.a.79317.1", "26795.a.26795.1", "26950.a.53900.1", "27046.a.54092.1", "27285.a.27285.1",
    "27352.a.54704.1", "27363.b.27363.1", "27399.a.82197.1", "27411.a.82233.1", "27523.a.27523.1",
    "27653.a.27653.1", "27811.a.27811.1", "27998.a.55996.1", "28091.a.28091.1", "28115.a.28115.1",
    "28117.b.28117.1", "28267.a.28267.1", "28778.a.57556.1", "29675.b.29675.1", "29793.a.89379.1",
    "29807.a.29807.1", "29937.a.89811.1", "30037.a.30037.1", "30103.a.30103.1", "30539.a.30539.1",
    "30589.a.30589.1", "30645.a.30645.1", "30659.a.30659.1", "30869.a.30869.1", "30917.a.30917.1",
    "30957.a.30957.1", "30982.a.61964.1", "31064.a.62128.1", "31072.a.62144.1", "31089.a.93267.1",
    "31579.a.31579.1", "31858.a.63716.1", "31881.a.95643.1", "32193.a.96579.1", "32391.a.97173.1",
    "32509.a.32509.1", "32728.a.65456.1", "32871.b.98613.1", "32962.a.65924.1", "33129.a.99387.1",
    "33365.a.33365.1", "33445.a.33445.1", "33491.a.33491.1", "33536.b.67072.1", "33632.b.67264.1",
    "33883.a.33883.1", "33952.a.67904.1", "33962.a.67924.1", "34571.a.34571.1", "34696.a.69392.1",
    "34747.a.34747.1", "35237.a.35237.1", "35273.a.35273.1", "35413.a.35413.1", "35488.b.70976.1",
    "35501.a.35501.1", "35627.b.35627.1", "36123.b.36123.1", "36262.b.72524.1", "36392.a.72784.1",
    "36469.a.36469.1", "36766.a.73532.1", "36794.a.73588.1", "37069.a.37069.1", "37357.a.37357.1",
    "37589.a.37589.1", "37901.a.37901.1", "37930.b.75860.1", "38056.a.76112.1", "38065.a.38065.1",
    "38419.b.38419.1", "38459.a.38459.1", "38510.a.38510.1", "38567.b.38567.1", "38711.a.38711.1",
    "38725.a.38725.1", "38893.a.38893.1", "38930.a.77860.1", "39013.a.39013.1", "39157.c.39157.1",
    "39467.a.39467.1", "39574.a.79148.1", "40207.a.40207.1", "40802.a.81604.1", "40864.b.81728.1",
    "40997.b.40997.1", "41120.a.82240.1", "41266.a.41266.1", "41491.a.41491.1", "42718.a.85436.1",
    "42983.a.42983.1", "43039.a.43039.1", "43349.a.43349.1", "43496.a.86992.1", "43568.a.43568.1",
    "44237.a.44237.1", "44277.a.44277.1", "44299.a.44299.1", "44309.b.44309.1", "44311.b.44311.1",
    "44366.a.88732.1", "44523.b.44523.1", "44662.a.44662.1", "44896.c.89792.1", "44896.d.89792.1",
    "44917.a.44917.1", "45159.a.45159.1", "45277.a.45277.1", "45358.a.45358.1", "45473.a.45473.1",
    "45614.a.91228.1", "45658.a.91316.1", "45749.a.45749.1", "45781.a.45781.1", "45934.a.91868.1",
    "46058.a.92116.1", "46069.a.46069.1", "46118.a.92236.1", "46149.a.46149.1", "46549.a.46549.1",
    "46818.b.93636.1", "47095.a.47095.1", "47221.a.47221.1", "47258.a.94516.1", "47389.a.47389.1",
    "47656.a.95312.1", "48193.a.48193.1", "48346.a.96692.1", "48619.a.48619.1", "48763.a.48763.1",
    "48763.b.48763.1", "48853.a.48853.1", "49024.a.98048.1", "49213.a.49213.1", "49237.a.49237.1",
    "49243.a.49243.1", "49337.a.49337.1", "49349.a.49349.1", "49568.a.99136.1", "49717.a.49717.1",
    "50117.a.50117.1", "50351.a.50351.1", "50737.a.50737.1", "50819.a.50819.1", "51131.b.51131.1",
    "51229.a.51229.1", "51346.a.51346.1", "51351.a.51351.1", "51673.a.51673.1", "51829.a.51829.1",
    "51882.a.51882.1", "52115.a.52115.1", "52165.c.52165.1", "52247.a.52247.1", "52469.a.52469.1",
    "52913.a.52913.1", "52913.b.52913.1", "52928.a.52928.1", "53341.a.53341.1", "53407.a.53407.1",
    "53683.a.53683.1", "53797.a.53797.1", "54475.a.54475.1", "54683.a.54683.1", "54709.a.54709.1",
    "54864.a.54864.1", "54979.a.54979.1", "55009.b.55009.1", "55014.a.55014.1", "55051.a.55051.1",
    "55178.a.55178.1", "55285.a.55285.1", "55856.a.55856.1", "55856.b.55856.1", "56149.a.56149.1",
    "56497.a.56497.1", "56731.a.56731.1", "57139.a.57139.1", "57649.a.57649.1", "57901.a.57901.1",
    "58421.b.58421.1", "58913.a.58913.1", "59317.a.59317.1", "59899.a.59899.1", "60407.a.60407.1",
    "60443.b.60443.1", "60706.a.60706.1", "60955.a.60955.1", "61013.a.61013.1", "61157.a.61157.1",
    "61267.a.61267.1", "61333.a.61333.1", "61501.b.61501.1", "61531.a.61531.1", "61771.a.61771.1",
    "61811.a.61811.1", "62090.a.62090.1", "62155.a.62155.1", "62197.a.62197.1", "62197.b.62197.1",
    "62231.a.62231.1", "62305.a.62305.1", "62549.a.62549.1", "62629.a.62629.1", "62723.a.62723.1",
    "62957.a.62957.1", "63271.a.63271.1", "63473.a.63473.1", "63537.a.63537.1", "63899.c.63899.1",
    "63997.b.63997.1", "64261.a.64261.1", "64757.a.64757.1", "65869.c.65869.1", "66197.a.66197.1",
    "66291.b.66291.1", "66403.a.66403.1", "66515.a.66515.1", "66607.a.66607.1", "66881.a.66881.1",
    "67229.a.67229.1", "67349.a.67349.1", "67637.a.67637.1", "67823.b.67823.1", "68001.a.68001.1",
    "68203.a.68203.1", "68389.a.68389.1", "68553.a.68553.1", "68861.a.68861.1", "69002.a.69002.1",
    "69157.a.69157.1", "69233.a.69233.1", "69646.a.69646.1", "70087.a.70087.1", "70651.a.70651.1",
    "70699.a.70699.1", "71095.a.71095.1", "71317.b.71317.1", "72491.a.72491.1", "73807.a.73807.1",
    "73813.a.73813.1", "74527.a.74527.1", "74549.a.74549.1", "75057.a.75057.1", "75206.a.75206.1",
    "75293.a.75293.1", "75631.b.75631.1", "76291.a.76291.1", "76441.a.76441.1", "77077.a.77077.1",
    "77147.a.77147.1", "77328.a.77328.1", "77491.a.77491.1", "77641.a.77641.1", "77965.a.77965.1",
    "78293.a.78293.1", "79315.a.79315.1", "79499.a.79499.1", "79687.a.79687.1", "80251.a.80251.1",
    "80294.a.80294.1", "80741.a.80741.1", "81451.a.81451.1", "81589.a.81589.1", "82357.a.82357.1",
    "82643.a.82643.1", "82649.a.82649.1", "82971.a.82971.1", "83059.a.83059.1", "83273.a.83273.1",
    "83279.a.83279.1", "83689.a.83689.1", "83819.a.83819.1", "83999.a.83999.1", "84229.a.84229.1",
    "85211.a.85211.1", "85225.a.85225.1", "85291.c.85291.1", "85733.a.85733.1", "86011.a.86011.1",
    "86123.a.86123.1", "86461.a.86461.1", "86555.a.86555.1", "86866.a.86866.1", "87041.a.87041.1",
    "87221.a.87221.1", "87365.a.87365.1", "88042.a.88042.1", "88241.a.88241.1", "88651.a.88651.1",
    "88960.b.88960.1", "89033.a.89033.1", "89605.b.89605.1", "89615.a.89615.1", "90439.a.90439.1",
    "90688.a.90688.1", "90959.a.90959.1", "91013.a.91013.1", "91587.a.91587.1", "91771.a.91771.1",
    "92209.a.92209.1", "92251.a.92251.1", "92947.a.92947.1", "92957.a.92957.1", "93031.b.93031.1",
    "93107.a.93107.1", "93341.a.93341.1", "93427.a.93427.1", "94079.a.94079.1", "94489.a.94489.1",
    "94709.a.94709.1", "94961.a.94961.1", "94971.a.94971.1", "95611.a.95611.1", "95929.a.95929.1",
    "96035.a.96035.1", "96197.a.96197.1", "96431.a.96431.1", "96821.a.96821.1", "97109.a.97109.1",
    "97133.a.97133.1", "97315.a.97315.1", "97397.a.97397.1", "97549.b.97549.1", "97589.a.97589.1",
    "97931.b.97931.1", "98163.a.98163.1", "98843.a.98843.1", "98947.a.98947.1", "99038.a.99038.1",
    "99223.a.99223.1", "99899.a.99899.1", "99903.a.99903.1", "99983.a.99983.1",
)

def main():
    with ProcessPool(initializer=set_memory_limit, initargs=(MAX_MEM,), max_workers=MAX_WORKERS, max_tasks=MAX_TASKS) as pool:
        future = pool.map(run_curve, TEST_LABELS, timeout=TIME_LIMIT)
        iterator = future.result()
        while True:
            try:
                result = next(iterator)
            except StopIteration:
                break
            except TimeoutError as error:
                print("Label {} took longer than {} seconds".format(label, error.args[1]))
            except ProcessExpired as error:
                print("Process for label {} expired.".format(label))
                print("{}. Exit code: {}".format(error, error.exitcode))
            except MemoryError as error:
                print("Process for label {} used over 1 GB of memory, giving up".format(label))
                print(error.traceback)
            except Exception as error:
                print("Label {} raised {}".format(label, error))
                print(error.traceback)

if __name__ == "__main__":
    main()


